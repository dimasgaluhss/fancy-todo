<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do</title>
    <style>

    </style>
</head>
<nav>
    <button id="btn-logout">Logout</button>
</nav>
<body>
    <div id="container">
        <!-- form login -->
        <div id="login-page">
            <form id="login-form">
                <!-- email login -->
                <div>
                    <label for="email-login">Email Address</label>
                    <input type="email" id="email-login">
                </div>
                <!-- password login -->
                <div>
                    <label for="password-login">Password</label>
                    <input type="password" id="password-login">
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- form todo -->
        <div id="main-page">
            <form id="form-todo">
                <!-- Title todo -->
                <div>
                    <label for="title-todo">Title</label>
                    <input type="text" id="title-todo">
                </div>
                <!-- Description todo -->
                <div>
                    <label for="desc-todo">Description</label>
                    <input type="text" id="desc-todo">
                </div>
                <!-- Due Date todo -->
                <div>
                    <label for="duedate-todo">Due Date</label>
                    <input type="date" id="duedate-todo">
                </div>
                <button type="submit">Submit</button>
            </form>
            <div id="todo-list">
                
            </div>
        </div>

    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script>
        function showLoginPage() {
            $('#login-page').show()
            $('#main-page').hide()
            $('#btn-logout').hide()
        }

        function showMainPage() {
            $('#login-page').hide()
            $('#main-page').show()
            $('#btn-logout').show()
            fetchToDo()
        }

        function login() {
            const email = $('#email-login').val()
            const password = $('#password-login').val()
    
            $.ajax({
                url: 'http://localhost:3000/user/login',
                method: 'POST',
                data: {
                    email,
                    password
                }
            })
            .done(response => {
                localStorage.setItem('access_token', response.access_token)
                showMainPage()
            })
            .fail((xhr, textStatus) => {
                console.log(xhr, textStatus)
            }) 

            .always(() => {
                $('#email-login').val('')
                $('#password-login').val('')
            })
        }

        function logout() {
            localStorage.clear()
            showLoginPage()
        }

        function fetchToDo() {
            $.ajax({
                method: 'GET',
                url: 'http://localhost:3000/todos',
                headers: {
                    access_token: localStorage.getItem('access_token')
                }
                
            })
            .done(response => {
                $("#todo-list").empty()
                console.log(response)
                let todo= response
                for(let i = 0; i < todo.length; i++) {
                    $('#todo-list').append(`<h3>${todo[i].title}</h3>
                <p>${todo[i].description}</p>
                <h5>${todo[i].status}</h5>
                <h5>${todo[i].due_date}</h5>
                <button onclick="deleteToDo(${todo[i].id})">Delete</button>`)
                }
            })

            .fail((xhr, textStatus) => {
                console.log(xhr, textStatus)
            })
        }

        function createToDo() {
            const title = $('#title-todo').val()
            const description = $('#desc-todo').val()
            const due_date = $('#duedate-todo').val()
            $.ajax({
                method: 'POST',
                url: 'http://localhost:3000/todos',
                headers: {
                    access_token: localStorage.getItem('access_token'),
                },
                data: {
                    title,
                    description,
                    due_date
                }
            })

            .done(response => {
                console.log(response)
                fetchToDo()
            })

            .fail((xhr, textStatus) => {
                console.log(xhr, textStatus)
            })

            .always(() => {
                $("#form-todo").trigger('reset')
            })
        }
        
        function deleteToDo(id) {
            $.ajax({
                method: 'DELETE',
                url: 'http://localhost:3000/todos/' + id,
                headers: {
                    access_token: localStorage.getItem('access_token')
                }
            })
            .done(response => {
                fetchToDo()
                console.log(response)
            })
            .fail((xhr, textStatus) => {
                console.log(xhr, textStatus)
            })
        }
        
        $(document).ready(function(){
            if(localStorage.getItem('access_token')){
                showMainPage()
            }
            else {
                showLoginPage()
            }
            $('#login-form').on('submit', function(e) {
                e.preventDefault()
                login()
            })

            $('#btn-logout').on('click', function (e) {
                logout()
            })

            $('#form-todo').on('submit', function(e) {
                e.preventDefault()
                createToDo()
            })
        });
    </script>
</body>
</html>